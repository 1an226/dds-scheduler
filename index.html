<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDS Ordering Desk Scheduler</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --rift: #e74c3c;
            --central: #3498db;
            --d2: #2ecc71;
            --d3: #f39c12;
            --off: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .user-info {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 5px;
            text-align: right;
            margin-top: 10px;
        }
        
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .analytics-btn {
            background-color: var(--success);
        }
        
        .logout-btn {
            background-color: var(--danger);
        }

        .standing-orders-btn {
            background-color: #9b59b6;
        }

        .summary-btn {
            background-color: #e67e22;
        }

        .patterns-btn {
            background-color: #16a085;
        }

        .leave-tracker-btn {
            background-color: #8e44ad;
        }
        
        .week-display {
            font-weight: bold;
            font-size: 18px;
        }

        /* Admin Controls */
        .admin-controls {
            background-color: #e8f6f3;
            border-left: 4px solid var(--success);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .admin-controls h3 {
            color: var(--success);
            margin-bottom: 10px;
        }

        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .schedule-table th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .schedule-table td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: center;
            position: relative;
        }
        
        .user-cell {
            font-weight: bold;
            background: #f8f9fa;
        }
        
        .current-user {
            background-color: #e8f4fc;
        }
        
        /* Shift Colors */
        .shift-rift { background-color: var(--rift); color: white; font-weight: bold; }
        .shift-central { background-color: var(--central); color: white; font-weight: bold; }
        .shift-d2 { background-color: var(--d2); color: white; font-weight: bold; }
        .shift-d3 { background-color: var(--d3); color: white; font-weight: bold; }
        .shift-off { background-color: var(--off); color: white; font-weight: bold; }
        .shift-leave { background-color: #fff9e6; color: var(--warning); font-weight: bold; }
        .shift-empty { background-color: #f8f9fa; color: #666; font-style: italic; }
        
        .on-leave {
            color: #95a5a6;
            font-style: italic;
        }
        
        .team-updates {
            background-color: #fff9e6;
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
        }
        
        .demo-note {
            margin-top: 20px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .hidden {
            display: none;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Analytics Modal */
        .analytics-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .analytics-modal.active {
            display: flex;
        }
        
        .analytics-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-btn:hover {
            color: var(--danger);
        }
        
        .metric {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .metric-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary);
        }

        .locked-banner {
            background-color: var(--warning);
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .date-range {
            font-size: 16px;
            color: #666;
            margin-top: 5px;
        }

        /* Standing Orders Modal */
        .standing-orders-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .standing-orders-modal.active {
            display: flex;
        }
        
        .standing-orders-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .order-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #9b59b6;
        }
        
        .order-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .order-details {
            color: #555;
            line-height: 1.5;
        }

        /* New Analytics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid var(--secondary);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .coverage-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid var(--success);
        }
        
        .pattern-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #16a085;
        }
        
        .leave-item {
            background: #fff9e6;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #f39c12;
        }
        
        .region-stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* Editable Cell Styles */
        .editable-cell {
            cursor: pointer !important;
            position: relative;
            transition: all 0.2s ease;
        }

        .editable-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--secondary);
            z-index: 10;
        }

        .editable-cell:hover::after {
            content: "✏️";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Shift Selector Styles */
        .shift-selector {
            position: fixed;
            background: white;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-wrap: wrap;
            width: 180px;
            padding: 5px;
        }

        .shift-option {
            padding: 10px 12px;
            cursor: pointer;
            flex: 1 0 50%;
            text-align: center;
            border: 1px solid #eee;
            border-radius: 4px;
            margin: 2px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .shift-option:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .shift-option.rift { background-color: var(--rift); color: white; }
        .shift-option.central { background-color: var(--central); color: white; }
        .shift-option.d2 { background-color: var(--d2); color: white; }
        .shift-option.d3 { background-color: var(--d3); color: white; }
        .shift-option.off { background-color: var(--off); color: white; }
        .shift-option.leave { background-color: #fff9e6; color: var(--warning); border: 1px solid var(--warning); }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <h1>DDS Ordering Desk Scheduler</h1>
        <div class="subtitle">Please login to continue</div>
        
        <div class="login-form">
            <div class="form-group">
                <label for="userSelect">Select User:</label>
                <select id="userSelect">
                    <option value="">-- Choose User --</option>
                    <option value="Ian">Ian (Admin)</option>
                    <option value="Kim">Kim</option>
                    <option value="Emma">Emma</option>
                    <option value="Kevo">Kevo</option>
                    <option value="Wendy">Wendy</option>
                    <option value="Janet">Janet</option>
                </select>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
            
            <button class="login-btn" onclick="login()">Login</button>
        </div>
        
        <div class="demo-note">
            <strong>Demo Access:</strong> Use default passwords
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <header>
            <h1>DDS Ordering Desk Scheduler</h1>
            <div class="subtitle">Weekly Duty Roster Management</div>
            <div class="user-info">
                <div id="loggedInUser">User</div>
                <div id="userStatus">Status</div>
            </div>
        </header>
        
        <!-- Admin Controls (only for Ian) -->
        <div id="adminControls" class="admin-controls hidden">
            <h3>Admin Controls</h3>
            <p>You can lock/unlock the roster and export data</p>
            <button class="btn btn-success" onclick="lockRoster()">Lock Roster</button>
            <button class="btn btn-warning" onclick="unlockRoster()">Unlock Roster</button>
            <button class="btn btn-danger" onclick="downloadJSON()">Export JSON</button>
            <button class="btn analytics-btn" onclick="showAnalytics()">Team Analytics</button>
        </div>

        <!-- Locked Banner -->
        <div id="lockedBanner" class="locked-banner hidden">
            🔒 Roster Locked - View Only Mode
        </div>
        
        <div class="nav-controls">
            <div class="week-nav">
                <button class="btn" onclick="changeWeek(-1)">&lt; Previous</button>
                <div>
                    <div class="week-display" id="weekDisplay">Week 42, 2025</div>
                    <div class="date-range" id="dateRange">13th Oct - 19th Oct 2025</div>
                </div>
                <button class="btn" onclick="changeWeek(1)">Next &gt;</button>
            </div>
            <div>
                <button class="btn summary-btn" onclick="showWeeklySummary()">Weekly Summary</button>
                <button class="btn patterns-btn" onclick="showShiftPatterns()">Shift Patterns</button>
                <button class="btn leave-tracker-btn" onclick="showLeaveTracker()">Leave Tracker</button>
                <button class="btn standing-orders-btn" onclick="showStandingOrders()">Standing Orders</button>
                <button class="btn analytics-btn" onclick="showAnalytics()" id="userAnalyticsBtn">My Analytics</button>
                <button class="btn logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Monday<br><span id="mondayDate">13th Oct</span></th>
                    <th>Tuesday<br><span id="tuesdayDate">14th Oct</span></th>
                    <th>Wednesday<br><span id="wednesdayDate">15th Oct</span></th>
                    <th>Thursday<br><span id="thursdayDate">16th Oct</span></th>
                    <th>Friday<br><span id="fridayDate">17th Oct</span></th>
                    <th>Saturday<br><span id="saturdayDate">18th Oct</span></th>
                    <th>Sunday<br><span id="sundayDate">19th Oct</span></th>
                </tr>
            </thead>
            <tbody id="scheduleBody">
                <!-- Filled by JavaScript -->
            </tbody>
        </table>
        
        <div class="team-updates">
            <h3>Team Updates</h3>
            <p id="teamUpdatesText">Emma is on long-term leave until February 2026</p>
            <p><strong>TPC - Mostly sunny</strong></p>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="analytics-modal">
        <div class="analytics-content">
            <button class="close-btn" onclick="hideAnalytics()">&times;</button>
            <h2 id="analyticsTitle">User Analytics</h2>
            <div id="analyticsContent">
                <!-- Analytics content -->
            </div>
        </div>
    </div>

    <!-- Standing Orders Modal -->
    <div id="standingOrdersModal" class="standing-orders-modal">
        <div class="standing-orders-content">
            <button class="close-btn" onclick="hideStandingOrders()">&times;</button>
            <h2>Daily Standing Orders</h2>
            <div id="standingOrdersContent">
                <div class="order-item">
                    <div class="order-title">Kamcan</div>
                    <div class="order-details">8CT 8 pieces, 1.5CT 1 piece</div>
                </div>
                <div class="order-item">
                    <div class="order-title">Coast Paradise</div>
                    <div class="order-details">8CT 10 pieces, 8Nutri 2 pieces and 1.5CT 3 pieces</div>
                </div>
                <div class="order-item">
                    <div class="order-title">Kilimall</div>
                    <div class="order-details">4CT 65 pieces, 4Nutri 13 pieces</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Summary Modal -->
    <div id="weeklySummaryModal" class="analytics-modal">
        <div class="analytics-content">
            <button class="close-btn" onclick="hideWeeklySummary()">&times;</button>
            <h2>Weekly Summary Dashboard</h2>
            <div id="weeklySummaryContent">
                <!-- Weekly summary content -->
            </div>
        </div>
    </div>

    <!-- Shift Patterns Modal -->
    <div id="shiftPatternsModal" class="analytics-modal">
        <div class="analytics-content">
            <button class="close-btn" onclick="hideShiftPatterns()">&times;</button>
            <h2>Shift Pattern Analytics</h2>
            <div id="shiftPatternsContent">
                <!-- Shift patterns content -->
            </div>
        </div>
    </div>

    <!-- Leave Tracker Modal -->
    <div id="leaveTrackerModal" class="analytics-modal">
        <div class="analytics-content">
            <button class="close-btn" onclick="hideLeaveTracker()">&times;</button>
            <h2>Leave & Absence Tracker</h2>
            <div id="leaveTrackerContent">
                <!-- Leave tracker content -->
            </div>
        </div>
    </div>

    <!-- Shift Selector (for editing cells) -->
    <div id="shiftSelector" class="shift-selector"></div>

    <script>
        // User credentials
        const userCredentials = {
            'Ian': 'OFtFusGT',
            'Kim': 'Tuesday',
            'Emma': 'Sunday',
            'Kevo': 'Thursday',
            'Wendy': 'Saturday',
            'Janet': 'Friday'
        };

        // Week configurations
        const weekConfigs = {
            41: {
                startDate: '2025-10-06',
                endDate: '2025-10-12',
                displayDate: '6th Oct - 12th Oct 2025',
                teamUpdates: 'Emma is on leave from Wednesday until February 2026 - Janet returns on Saturday',
                activeUsers: ['Ian', 'Kim', 'Emma', 'Kevo', 'Wendy', 'Janet'],
                scheduleData: {
                    'Ian': ['Rift', 'Central', 'D2', 'Rift', 'D3', 'Central', 'D3'],
                    'Kim': ['OFF', 'D3', 'Central', 'D2', 'Rift', 'D3', 'Central'],
                    'Emma': ['D3', 'OFF', 'Leave', 'Leave', 'Leave', 'Leave', 'Leave'],
                    'Kevo': ['D2', 'Rift', 'D3', 'Central', 'D2', 'Rift', 'OFF'],
                    'Wendy': ['Central', 'D2', 'Rift', 'D3', 'Central', 'OFF', 'D2'],
                    'Janet': ['OFF', 'OFF', 'OFF', 'OFF', 'OFF', 'D2', 'Rift']
                }
            },
            42: {
                startDate: '2025-10-13',
                endDate: '2025-10-19',
                displayDate: '13th Oct - 19th Oct 2025',
                teamUpdates: 'Emma is on long-term leave until February 2026',
                activeUsers: ['Ian', 'Kim', 'Kevo', 'Wendy', 'Janet'], // Emma removed
                scheduleData: {
                    'Ian': ['', '', '', '', '', '', ''],
                    'Kim': ['', '', '', '', '', '', ''],
                    'Kevo': ['', '', '', '', '', '', ''],
                    'Wendy': ['', '', '', '', '', '', ''],
                    'Janet': ['', '', '', '', '', '', '']
                }
            }
        };

        const regions = ['Rift', 'Central', 'D2', 'D3'];
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let currentUser = '';
        let currentWeek = 42; // Start with Week 42
        let isRosterLocked = true; // Default to locked
        let currentEditingCell = null;

        function initializePage() {
            checkLogin();
            updateLockedState();
            setupShiftSelector();
        }

        function setupShiftSelector() {
            const shiftSelector = document.getElementById('shiftSelector');
            const shiftOptions = ['Rift', 'Central', 'D2', 'D3', 'OFF', 'Leave'];
            
            shiftSelector.innerHTML = ''; // Clear existing options
            
            shiftOptions.forEach(shift => {
                const option = document.createElement('div');
                option.className = `shift-option ${shift.toLowerCase()}`;
                option.textContent = shift;
                option.onclick = () => selectShift(shift);
                shiftSelector.appendChild(option);
            });

            // Close selector when clicking outside
            document.addEventListener('click', function(e) {
                if (!shiftSelector.contains(e.target) && !e.target.classList.contains('editable-cell')) {
                    shiftSelector.style.display = 'none';
                    currentEditingCell = null;
                }
            });
        }

        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            setupUserExperience();
            renderSchedule();
            updateLockedState();
        }

        function setupUserExperience() {
            const isAdmin = currentUser === 'Ian';
            
            document.getElementById('loggedInUser').textContent = 
                currentUser + (isAdmin ? ' (Admin)' : '');
            document.getElementById('userStatus').textContent = 
                currentUser === 'Emma' ? 'on leave until February 2026' : 'viewing roster';
            
            // Show admin controls only for Ian
            if (isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('userAnalyticsBtn').textContent = 'Team Analytics';
            } else {
                document.getElementById('adminControls').classList.add('hidden');
                document.getElementById('userAnalyticsBtn').textContent = 'My Analytics';
            }
        }

        function updateLockedState() {
            const lockedBanner = document.getElementById('lockedBanner');
            // Week 41 is always locked, Week 42 can be unlocked
            if (isRosterLocked || currentWeek === 41) {
                lockedBanner.classList.remove('hidden');
                if (currentWeek === 41) {
                    lockedBanner.textContent = '🔒 Week 41 Roster Locked - Historical View Only';
                } else {
                    lockedBanner.textContent = '🔒 Roster Locked - View Only Mode';
                }
            } else {
                lockedBanner.classList.add('hidden');
            }
            
            // Update cell editability
            updateCellEditability();
        }

        function updateCellEditability() {
            const cells = document.querySelectorAll('.schedule-table td:not(.user-cell)');
            cells.forEach(cell => {
                // Week 41 is always locked, Week 42 can be edited by admin when unlocked
                if (isRosterLocked || currentUser !== 'Ian' || currentWeek === 41) {
                    cell.classList.remove('editable-cell');
                    cell.onclick = null;
                } else {
                    cell.classList.add('editable-cell');
                    // Find user and day index for this cell
                    const row = cell.parentElement;
                    const userName = row.cells[0].textContent.replace(/ \(.*\)/, '');
                    const dayIndex = Array.from(row.cells).indexOf(cell) - 1; // -1 because first cell is name
                    
                    cell.onclick = (e) => showShiftSelector(e, userName, dayIndex);
                }
            });
        }

        // Week Navigation
        function changeWeek(weekDelta) {
            const newWeek = currentWeek + weekDelta;
            
            // Only allow navigation to weeks that exist in our config
            if (weekConfigs[newWeek]) {
                currentWeek = newWeek;
                renderSchedule();
                updateWeekDisplay();
                
                // Auto-lock Week 41 when navigating to it
                if (currentWeek === 41) {
                    isRosterLocked = true;
                }
                updateLockedState();
            } else {
                alert(`Week ${newWeek} data not available`);
            }
        }

        function updateWeekDisplay() {
            const config = weekConfigs[currentWeek];
            document.getElementById('weekDisplay').textContent = `Week ${currentWeek}, 2025`;
            document.getElementById('dateRange').textContent = config.displayDate;
            document.getElementById('teamUpdatesText').textContent = config.teamUpdates;
            
            // Update date headers
            const startDate = new Date(config.startDate);
            document.getElementById('mondayDate').textContent = formatDate(startDate);
            document.getElementById('tuesdayDate').textContent = formatDate(addDays(startDate, 1));
            document.getElementById('wednesdayDate').textContent = formatDate(addDays(startDate, 2));
            document.getElementById('thursdayDate').textContent = formatDate(addDays(startDate, 3));
            document.getElementById('fridayDate').textContent = formatDate(addDays(startDate, 4));
            document.getElementById('saturdayDate').textContent = formatDate(addDays(startDate, 5));
            document.getElementById('sundayDate').textContent = formatDate(addDays(startDate, 6));
        }

        function formatDate(date) {
            const day = date.getDate();
            const suffix = getDaySuffix(day);
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            return `${day}${suffix} ${month}`;
        }

        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // Admin Functions
        function lockRoster() {
            if (currentWeek === 41) {
                alert('Week 41 is permanently locked for historical reference.');
                return;
            }
            isRosterLocked = true;
            updateLockedState();
            alert('Roster locked! All users now have view-only access.');
            downloadJSON(); // Automatically download JSON when locked
        }

        function unlockRoster() {
            if (currentWeek === 41) {
                alert('Week 41 is permanently locked for historical reference.');
                return;
            }
            isRosterLocked = false;
            updateLockedState();
            alert('Roster unlocked! Admin can now make changes.');
        }

        function downloadJSON() {
            const config = weekConfigs[currentWeek];
            // Create the JSON data structure
            const jsonData = {
                scheduleData: {},
                isRosterLocked: isRosterLocked,
                currentWeek: currentWeek,
                currentYear: 2025,
                dateRange: config.displayDate,
                lastSavedTime: new Date().toISOString(),
                updatedBy: currentUser
            };

            // Convert schedule data to the key-value format
            config.activeUsers.forEach(user => {
                config.scheduleData[user].forEach((shift, dayIndex) => {
                    const dayName = days[dayIndex];
                    jsonData.scheduleData[`${user}-${dayName}`] = shift || 'Empty';
                });
            });

            // Convert to JSON string
            const jsonString = JSON.stringify(jsonData, null, 2);
            
            // Create download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `roster_week${currentWeek}_2025_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('JSON file downloaded! You can now upload this to GitHub.');
        }

        function login() {
            const userSelect = document.getElementById('userSelect');
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const selectedUser = userSelect.value;
            
            errorMessage.classList.add('hidden');
            
            if (!selectedUser) {
                showError('Please select a user');
                return;
            }
            
            if (!password) {
                showError('Please enter password');
                return;
            }
            
            if (password === userCredentials[selectedUser]) {
                currentUser = selectedUser;
                localStorage.setItem('currentUser', currentUser);
                showMainApp();
            } else {
                showError('Invalid password');
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('currentUser');
            showLoginPage();
        }

        function renderSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            const config = weekConfigs[currentWeek];
            const activeUsers = config.activeUsers;
            
            activeUsers.forEach(user => {
                const row = document.createElement('tr');
                if (user === currentUser) row.classList.add('current-user');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'user-cell';
                if (user === 'Emma') {
                    nameCell.innerHTML = user + ' <span class="on-leave">(on leave)</span>';
                } else if (user === 'Janet' && currentWeek === 41) {
                    nameCell.innerHTML = user + ' <span class="on-leave">(returns Saturday)</span>';
                } else {
                    nameCell.textContent = user;
                }
                row.appendChild(nameCell);
                
                // Shift cells with PROPER COLORS
                config.scheduleData[user].forEach((shift, index) => {
                    const cell = document.createElement('td');
                    
                    if (shift === 'Rift') cell.className = 'shift-rift';
                    else if (shift === 'Central') cell.className = 'shift-central';
                    else if (shift === 'D2') cell.className = 'shift-d2';
                    else if (shift === 'D3') cell.className = 'shift-d3';
                    else if (shift === 'OFF') cell.className = 'shift-off';
                    else if (shift === 'Leave') cell.className = 'shift-leave';
                    else if (shift === '') {
                        cell.className = 'shift-empty';
                        cell.textContent = 'Click to set';
                    } else {
                        cell.textContent = shift;
                    }
                    
                    // Store user and day index as data attributes
                    cell.setAttribute('data-user', user);
                    cell.setAttribute('data-day', index);
                    
                    row.appendChild(cell);
                });
                
                scheduleBody.appendChild(row);
            });

            updateWeekDisplay();
            updateCellEditability(); // Make sure editability is set after rendering
        }

        // Cell Editing Functions
        function showShiftSelector(event, user, dayIndex) {
            // Week 41 is always locked
            if (currentWeek === 41) {
                alert('Week 41 is locked for historical reference. Please edit Week 42 instead.');
                return;
            }
            
            if (isRosterLocked || currentUser !== 'Ian') return;
            
            currentEditingCell = { user, dayIndex, element: event.target };
            
            const shiftSelector = document.getElementById('shiftSelector');
            const rect = event.target.getBoundingClientRect();
            
            // Position selector near the cell
            shiftSelector.style.left = `${rect.left + window.pageXOffset}px`;
            shiftSelector.style.top = `${rect.bottom + window.pageYOffset + 5}px`;
            shiftSelector.style.display = 'flex';
            
            event.stopPropagation(); // Prevent immediate closing
        }

        function selectShift(shift) {
            if (!currentEditingCell) return;
            
            const { user, dayIndex, element } = currentEditingCell;
            
            console.log(`Changing ${user}'s ${days[dayIndex]} shift to ${shift}`);
            
            // Update the data model
            weekConfigs[currentWeek].scheduleData[user][dayIndex] = shift;
            
            // Update the cell display
            element.textContent = shift;
            element.className = '';
            
            // Apply the correct class based on shift type
            if (shift === 'Rift') element.className = 'shift-rift';
            else if (shift === 'Central') element.className = 'shift-central';
            else if (shift === 'D2') element.className = 'shift-d2';
            else if (shift === 'D3') element.className = 'shift-d3';
            else if (shift === 'OFF') element.className = 'shift-off';
            else if (shift === 'Leave') element.className = 'shift-leave';
            
            // Hide the selector
            document.getElementById('shiftSelector').style.display = 'none';
            currentEditingCell = null;
            
            // Re-apply editability to maintain click handlers
            updateCellEditability();
        }

        // Analytics Functions
        function showAnalytics() {
            const modal = document.getElementById('analyticsModal');
            const title = document.getElementById('analyticsTitle');
            const content = document.getElementById('analyticsContent');
            
            if (currentUser === 'Ian') {
                title.textContent = 'Team Analytics - Admin View';
                content.innerHTML = generateTeamAnalytics();
            } else {
                title.textContent = currentUser + "'s Analytics";
                content.innerHTML = generateUserAnalytics(currentUser);
            }
            
            modal.classList.add('active');
        }

        function hideAnalytics() {
            document.getElementById('analyticsModal').classList.remove('active');
        }

        // New Analytics Functions
        function showWeeklySummary() {
            const modal = document.getElementById('weeklySummaryModal');
            const content = document.getElementById('weeklySummaryContent');
            content.innerHTML = generateWeeklySummary();
            modal.classList.add('active');
        }

        function hideWeeklySummary() {
            document.getElementById('weeklySummaryModal').classList.remove('active');
        }

        function showShiftPatterns() {
            const modal = document.getElementById('shiftPatternsModal');
            const content = document.getElementById('shiftPatternsContent');
            content.innerHTML = generateShiftPatterns();
            modal.classList.add('active');
        }

        function hideShiftPatterns() {
            document.getElementById('shiftPatternsModal').classList.remove('active');
        }

        function showLeaveTracker() {
            const modal = document.getElementById('leaveTrackerModal');
            const content = document.getElementById('leaveTrackerContent');
            content.innerHTML = generateLeaveTracker();
            modal.classList.add('active');
        }

        function hideLeaveTracker() {
            document.getElementById('leaveTrackerModal').classList.remove('active');
        }

        // Standing Orders Functions
        function showStandingOrders() {
            document.getElementById('standingOrdersModal').classList.add('active');
        }

        function hideStandingOrders() {
            document.getElementById('standingOrdersModal').classList.remove('active');
        }

        // Data Analysis Functions
        function generateWeeklySummary() {
            const config = weekConfigs[currentWeek];
            // Calculate statistics
            let totalShifts = 0;
            let regionCounts = { Rift: 0, Central: 0, D2: 0, D3: 0 };
            let dayCoverage = {};
            
            days.forEach(day => dayCoverage[day] = { Rift: 0, Central: 0, D2: 0, D3: 0 });
            
            config.activeUsers.forEach(user => {
                config.scheduleData[user].forEach((shift, dayIndex) => {
                    if (regions.includes(shift)) {
                        totalShifts++;
                        regionCounts[shift]++;
                        dayCoverage[days[dayIndex]][shift]++;
                    }
                });
            });

            const workingStaff = config.activeUsers.filter(user => 
                config.scheduleData[user].some(shift => regions.includes(shift))
            ).length;

            const emptyCells = config.activeUsers.reduce((total, user) => {
                return total + config.scheduleData[user].filter(shift => shift === '').length;
            }, 0);

            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${totalShifts}</div>
                        <div class="stat-label">Total Shifts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${workingStaff}/${config.activeUsers.length}</div>
                        <div class="stat-label">Active Staff</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${emptyCells}</div>
                        <div class="stat-label">Empty Cells</div>
                    </div>
                </div>

                <h3>Region Distribution</h3>
                ${Object.entries(regionCounts).map(([region, count]) => `
                    <div class="region-stats">
                        <span>${region}:</span>
                        <span><strong>${count}</strong> shifts</span>
                    </div>
                `).join('')}

                <h3>Daily Coverage</h3>
                ${Object.entries(dayCoverage).map(([day, coverage]) => `
                    <div class="coverage-item">
                        <strong>${day}</strong><br>
                        ${Object.entries(coverage).map(([region, count]) => 
                            `${region}: ${count}`).join(' • ')}
                    </div>
                `).join('')}
            `;
        }

        function generateShiftPatterns() {
            const config = weekConfigs[currentWeek];
            let userPatterns = {};
            
            config.activeUsers.forEach(user => {
                const shifts = config.scheduleData[user];
                const pattern = shifts.map(shift => shift || 'Empty').join(' → ');
                const regionFrequency = {};
                
                shifts.forEach(shift => {
                    if (regions.includes(shift)) {
                        regionFrequency[shift] = (regionFrequency[shift] || 0) + 1;
                    }
                });
                
                userPatterns[user] = {
                    pattern: pattern,
                    frequency: regionFrequency,
                    totalShifts: Object.values(regionFrequency).reduce((a, b) => a + b, 0),
                    emptyDays: shifts.filter(shift => shift === '').length
                };
            });

            return `
                <h3>Individual Shift Patterns</h3>
                ${Object.entries(userPatterns).map(([user, data]) => `
                    <div class="pattern-item">
                        <strong>${user}</strong><br>
                        <small>Pattern: ${data.pattern}</small><br>
                        <small>Total shifts: ${data.totalShifts} • Empty days: ${data.emptyDays}</small><br>
                        ${Object.entries(data.frequency).map(([region, count]) => 
                            `<span style="color: #666">${region}: ${count} </span>`).join('')}
                    </div>
                `).join('')}

                <h3>Most Common Regions</h3>
                ${Object.entries(calculateRegionPreferences()).map(([user, preferences]) => `
                    <div class="metric">
                        <div class="metric-label">${user}</div>
                        <div class="metric-value">${preferences.length > 0 ? preferences.join(', ') : 'No shifts assigned'}</div>
                    </div>
                `).join('')}
            `;
        }

        function generateLeaveTracker() {
            const config = weekConfigs[currentWeek];
            const leaveData = [];
            
            // Include Emma in leave tracker even if she's not in active users
            const allUsersToCheck = currentWeek >= 42 ? 
                [...config.activeUsers, 'Emma'] : config.activeUsers;
            
            allUsersToCheck.forEach(user => {
                let leaveDays = 0;
                let offDays = 0;
                let emptyDays = 0;
                
                if (user === 'Emma' && currentWeek >= 42) {
                    // Emma is on long-term leave
                    leaveData.push({
                        user: user,
                        leaveDays: 7, // Full week on leave
                        offDays: 0,
                        emptyDays: 0,
                        status: 'On long-term leave until Feb 2026'
                    });
                } else {
                    const shifts = config.scheduleData[user] || [];
                    leaveDays = shifts.filter(shift => shift === 'Leave').length;
                    offDays = shifts.filter(shift => shift === 'OFF').length;
                    emptyDays = shifts.filter(shift => shift === '').length;
                    
                    if (leaveDays > 0 || user === 'Emma' || emptyDays > 0) {
                        leaveData.push({
                            user: user,
                            leaveDays: leaveDays,
                            offDays: offDays,
                            emptyDays: emptyDays,
                            status: user === 'Emma' ? 'On long-term leave until Feb 2026' : 
                                   leaveDays > 0 ? `On leave (${leaveDays} days)` : 
                                   emptyDays > 0 ? `Pending schedule (${emptyDays} days)` : 'Available'
                        });
                    }
                }
            });

            return `
                <h3>Current Leave Status</h3>
                ${leaveData.map(data => `
                    <div class="leave-item">
                        <strong>${data.user}</strong><br>
                        <span>${data.status}</span><br>
                        <small>Leave days: ${data.leaveDays} • OFF days: ${data.offDays} • Empty: ${data.emptyDays}</small>
                    </div>
                `).join('')}

                <h3>Team Availability</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${leaveData.filter(d => d.leaveDays > 0).length}</div>
                        <div class="stat-label">On Leave</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${config.activeUsers.length}</div>
                        <div class="stat-label">Available Staff</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${leaveData.reduce((sum, d) => sum + d.emptyDays, 0)}</div>
                        <div class="stat-label">Pending Schedule</div>
                    </div>
                </div>
            `;
        }

        function calculateRegionPreferences() {
            const config = weekConfigs[currentWeek];
            let preferences = {};
            config.activeUsers.forEach(user => {
                const regionCount = {};
                config.scheduleData[user].forEach(shift => {
                    if (regions.includes(shift)) {
                        regionCount[shift] = (regionCount[shift] || 0) + 1;
                    }
                });
                // Get top 2 most frequent regions
                preferences[user] = Object.entries(regionCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 2)
                    .map(([region]) => region);
            });
            return preferences;
        }

        function generateUserAnalytics(user) {
            const config = weekConfigs[currentWeek];
            const shifts = config.scheduleData[user] || [];
            const workingDays = shifts.filter(s => !['OFF', 'Leave', ''].includes(s)).length;
            const offDays = shifts.filter(s => s === 'OFF').length;
            const leaveDays = shifts.filter(s => s === 'Leave').length;
            const emptyDays = shifts.filter(s => s === '').length;
            
            return `
                <div class="metric">
                    <div class="metric-label">Working Days</div>
                    <div class="metric-value">${workingDays}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">OFF Days</div>
                    <div class="metric-value">${offDays}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Leave Days</div>
                    <div class="metric-value">${leaveDays}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Empty Days</div>
                    <div class="metric-value">${emptyDays}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total Scheduled</div>
                    <div class="metric-value">${workingDays + offDays + leaveDays} of ${shifts.length} days</div>
                </div>
            `;
        }

        function generateTeamAnalytics() {
            const config = weekConfigs[currentWeek];
            let html = '';
            
            config.activeUsers.forEach(user => {
                const shifts = config.scheduleData[user];
                const workingDays = shifts.filter(s => !['OFF', 'Leave', ''].includes(s)).length;
                const emptyDays = shifts.filter(s => s === '').length;
                
                html += `
                    <div class="metric">
                        <div class="metric-label">${user}</div>
                        <div class="metric-value">${workingDays} working days${emptyDays > 0 ? ` (${emptyDays} empty)` : ''}</div>
                    </div>
                `;
            });
            
            return html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initializePage);

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideAnalytics();
                hideStandingOrders();
                hideWeeklySummary();
                hideShiftPatterns();
                hideLeaveTracker();
                document.getElementById('shiftSelector').style.display = 'none';
            }
        });

        // Close modals when clicking outside
        const modals = ['analyticsModal', 'standingOrdersModal', 'weeklySummaryModal', 'shiftPatternsModal', 'leaveTrackerModal'];
        modals.forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Enter key to login
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>

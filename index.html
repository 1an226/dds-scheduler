<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDS Ordering Desk Scheduler</title>
    <style>
        /* [KEEP ALL YOUR EXISTING CSS STYLES - NO CHANGES] */
        /* ... All CSS styles remain exactly the same ... */
    </style>
</head>
<body>
    <!-- [KEEP ALL YOUR EXISTING HTML - NO CHANGES] -->
    <!-- ... All HTML markup remains exactly the same ... -->
    
    <script>
        // User credentials - NO CHANGES
        const userCredentials = {
            'Ian': 'OFtFusGT',
            'Kim': 'Tuesday',
            'Emma': 'Sunday',
            'Kevo': 'Thursday',
            'Wendy': 'Saturday',
            'Janet': 'Friday'
        };

        // Function to get the Monday of a given week
        function getMondayOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust Sunday
            return new Date(date.setDate(diff));
        }

        // Function to get week number from date (ISO week)
        function getWeekNumber(date) {
            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        // Function to get date for a specific week and year
        function getDateOfISOWeek(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            } else {
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            }
            return ISOweekStart;
        }

        // Function to format date with ordinal suffix
        function formatDateWithSuffix(date) {
            const day = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const year = date.getFullYear();
            
            const suffix = getDaySuffix(day);
            return `${day}${suffix} ${month} ${year}`;
        }

        // Function to get day suffix
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }

        // Generate week configs dynamically starting from today
        const generateWeekConfigs = () => {
            const configs = {};
            const today = new Date(2025, 11, 8); // December 8th, 2025 (0-indexed month: 11 = Dec)
            const currentWeekStart = getMondayOfWeek(new Date(today));
            const currentWeekNumber = getWeekNumber(today);
            const currentYear = today.getFullYear();
            
            console.log('Today:', today);
            console.log('Week start:', currentWeekStart);
            console.log('Week number:', currentWeekNumber);
            
            // Generate empty schedule template
            const getEmptySchedule = () => {
                return {
                    'Ian': ['', '', '', '', '', '', ''],
                    'Kim': ['', '', '', '', '', '', ''],
                    'Kevo': ['', '', '', '', '', '', ''],
                    'Wendy': ['', '', '', '', '', '', ''],
                    'Janet': ['', '', '', '', '', '', '']
                };
            };

            // WEEK 1: Current week starting Dec 8th (Monday) - EMPTY AND EDITABLE
            const week1Start = new Date(currentWeekStart);
            const week1End = new Date(week1Start);
            week1End.setDate(week1End.getDate() + 6);
            
            configs[currentWeekNumber] = {
                startDate: week1Start.toISOString().split('T')[0],
                endDate: week1End.toISOString().split('T')[0],
                displayDate: `${formatDateWithSuffix(week1Start)} - ${formatDateWithSuffix(week1End)}`,
                teamUpdates: 'This week\'s schedule is being populated',
                activeUsers: ['Ian', 'Kim', 'Kevo', 'Wendy', 'Janet'],
                scheduleData: getEmptySchedule()
            };

            // WEEK 2: Next week - EMPTY
            const week2Start = new Date(week1Start);
            week2Start.setDate(week2Start.getDate() + 7);
            const week2End = new Date(week2Start);
            week2End.setDate(week2End.getDate() + 6);
            
            configs[currentWeekNumber + 1] = {
                startDate: week2Start.toISOString().split('T')[0],
                endDate: week2End.toISOString().split('T')[0],
                displayDate: `${formatDateWithSuffix(week2Start)} - ${formatDateWithSuffix(week2End)}`,
                teamUpdates: 'Future week - Schedule pending',
                activeUsers: ['Ian', 'Kim', 'Kevo', 'Wendy', 'Janet'],
                scheduleData: getEmptySchedule()
            };

            // WEEK 3: Week after next - EMPTY
            const week3Start = new Date(week1Start);
            week3Start.setDate(week3Start.getDate() + 14);
            const week3End = new Date(week3Start);
            week3End.setDate(week3End.getDate() + 6);
            
            configs[currentWeekNumber + 2] = {
                startDate: week3Start.toISOString().split('T')[0],
                endDate: week3End.toISOString().split('T')[0],
                displayDate: `${formatDateWithSuffix(week3Start)} - ${formatDateWithSuffix(week3End)}`,
                teamUpdates: 'Future week - Schedule pending',
                activeUsers: ['Ian', 'Kim', 'Kevo', 'Wendy', 'Janet'],
                scheduleData: getEmptySchedule()
            };

            // Add a few historical placeholder weeks (weeks 41-44) as reference if needed
            // You can remove these if you want to start completely fresh
            for (let week = 41; week <= 44; week++) {
                const histStart = getDateOfISOWeek(2025, week);
                const histEnd = new Date(histStart);
                histEnd.setDate(histEnd.getDate() + 6);
                
                configs[week] = {
                    startDate: histStart.toISOString().split('T')[0],
                    endDate: histEnd.toISOString().split('T')[0],
                    displayDate: `${formatDateWithSuffix(histStart)} - ${formatDateWithSuffix(histEnd)}`,
                    teamUpdates: 'Historical reference week - View only',
                    activeUsers: ['Ian', 'Kim', 'Kevo', 'Wendy', 'Janet'],
                    scheduleData: getEmptySchedule(),
                    isHistorical: true
                };
            }
            
            return configs;
        };

        const weekConfigs = generateWeekConfigs();
        
        const regions = ['Rift', 'Central', 'D2', 'D3', 'Others'];
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        // Get today's week number
        const today = new Date(2025, 11, 8); // December 8th, 2025
        const currentWeekNumber = getWeekNumber(today);
        
        let currentUser = '';
        let currentWeek = currentWeekNumber; // Start with current week
        let currentYear = 2025;
        let isRosterLocked = false; // Current week starts UNLOCKED for editing
        let isAdmin = false;

        function initializePage() {
            checkLogin();
            updateLockedState();
        }

        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                isAdmin = currentUser === 'Ian';
                showMainApp();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            setupUserExperience();
            renderSchedule();
            updateLockedState();
        }

        function setupUserExperience() {
            document.getElementById('loggedInUser').textContent = 
                currentUser + (isAdmin ? ' (Admin)' : '');
            document.getElementById('userStatus').textContent = 
                currentUser === 'Emma' ? 'on leave until February 2026' : 'viewing roster';
            
            // Show admin controls only for Ian
            if (isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('userAnalyticsBtn').textContent = 'Team Analytics';
            } else {
                document.getElementById('adminControls').classList.add('hidden');
                document.getElementById('userAnalyticsBtn').textContent = 'My Analytics';
            }
        }

        function updateLockedState() {
            const lockedBanner = document.getElementById('lockedBanner');
            const config = weekConfigs[currentWeek];
            
            // Check if it's a historical week (weeks 41-44)
            if (config && config.isHistorical) {
                isRosterLocked = true;
                lockedBanner.classList.remove('hidden');
                lockedBanner.textContent = `ðŸ”’ Week ${currentWeek} (Historical) - View Only Mode`;
            } 
            // Current week starts unlocked, but can be locked by admin
            else if (isRosterLocked) {
                lockedBanner.classList.remove('hidden');
                lockedBanner.textContent = 'ðŸ”’ Roster Locked - View Only Mode';
            } else {
                lockedBanner.classList.add('hidden');
            }
            
            // Update cell editability
            updateCellEditability();
        }

        function updateCellEditability() {
            const cells = document.querySelectorAll('.schedule-table td:not(.user-cell)');
            cells.forEach(cell => {
                const config = weekConfigs[currentWeek];
                const isHistorical = config && config.isHistorical;
                
                if (isRosterLocked || !isAdmin || isHistorical) {
                    cell.classList.remove('editable-cell');
                    cell.onclick = null;
                } else {
                    cell.classList.add('editable-cell');
                    cell.onclick = handleCellClick;
                }
            });
        }

        // === Simple Click-to-Cycle Editing ===
        function handleCellClick(event) {
            const config = weekConfigs[currentWeek];
            if (config && config.isHistorical) {
                alert(`Week ${currentWeek} is a historical reference week and cannot be edited.`);
                return;
            }
            
            if (isRosterLocked || !isAdmin) return;
            
            const cell = event.target;
            const userName = cell.dataset.user;
            const dayIndex = parseInt(cell.dataset.day);
    
            const currentAssignment = cell.textContent;
            const shiftOptions = ['Rift', 'Central', 'D2', 'D3', 'Others', 'OFF', 'Leave'];
            
            // Find current assignment in options
            let currentIndex = shiftOptions.indexOf(currentAssignment);
            if (currentIndex === -1) {
                // If current assignment not found, start from beginning
                currentIndex = -1;
            }
            
            // Cycle to next option
            const nextIndex = (currentIndex + 1) % shiftOptions.length;
            const nextAssignment = shiftOptions[nextIndex];
            
            // Update the data model
            weekConfigs[currentWeek].scheduleData[userName][dayIndex] = nextAssignment;
            
            // Update the cell display
            updateCellAppearance(cell, nextAssignment);
        }

        function updateCellAppearance(cell, assignment) {
            cell.textContent = assignment;
            cell.className = '';
            
            // Apply the correct class based on shift type
            if (assignment === 'Rift') cell.className = 'shift-rift';
            else if (assignment === 'Central') cell.className = 'shift-central';
            else if (assignment === 'D2') cell.className = 'shift-d2';
            else if (assignment === 'D3') cell.className = 'shift-d3';
            else if (assignment === 'Others') cell.className = 'shift-others';
            else if (assignment === 'OFF') cell.className = 'shift-off';
            else if (assignment === 'Leave') cell.className = 'shift-leave';
            else if (assignment === '') {
                cell.className = 'shift-empty';
                cell.textContent = 'Click to set';
            }
            
            // Keep it editable if admin and unlocked
            const config = weekConfigs[currentWeek];
            const isHistorical = config && config.isHistorical;
            
            if (isAdmin && !isRosterLocked && !isHistorical) {
                cell.classList.add('editable-cell');
            }
        }

        // Week Navigation
        function changeWeek(weekDelta) {
            const newWeek = currentWeek + weekDelta;
            
            // Find available weeks (keys of weekConfigs)
            const availableWeeks = Object.keys(weekConfigs).map(Number).sort((a, b) => a - b);
            const minWeek = Math.min(...availableWeeks);
            const maxWeek = Math.max(...availableWeeks);
            
            if (newWeek >= minWeek && newWeek <= maxWeek) {
                currentWeek = newWeek;
                
                // Check if it's a historical week
                const config = weekConfigs[currentWeek];
                if (config && config.isHistorical) {
                    isRosterLocked = true;
                } else if (currentWeek === getWeekNumber(new Date(2025, 11, 8))) {
                    // Current week - check if admin has locked it
                    // isRosterLocked remains as is (could be true or false)
                } else {
                    // Future weeks start unlocked
                    isRosterLocked = false;
                }
                
                renderSchedule();
                updateWeekDisplay();
                updateLockedState();
            } else {
                alert(`Week ${newWeek} is not available. Please stay within weeks ${minWeek}-${maxWeek}.`);
            }
        }

        function updateWeekDisplay() {
            const config = weekConfigs[currentWeek];
            if (!config) {
                console.error(`No config found for week ${currentWeek}`);
                return;
            }
            
            document.getElementById('weekDisplay').textContent = `Week ${currentWeek}, ${currentYear}`;
            document.getElementById('dateRange').textContent = config.displayDate;
            document.getElementById('teamUpdatesText').textContent = config.teamUpdates;
            
            // Update date headers
            const startDate = new Date(config.startDate);
            document.getElementById('mondayDate').textContent = formatDate(startDate);
            document.getElementById('tuesdayDate').textContent = formatDate(addDays(startDate, 1));
            document.getElementById('wednesdayDate').textContent = formatDate(addDays(startDate, 2));
            document.getElementById('thursdayDate').textContent = formatDate(addDays(startDate, 3));
            document.getElementById('fridayDate').textContent = formatDate(addDays(startDate, 4));
            document.getElementById('saturdayDate').textContent = formatDate(addDays(startDate, 5));
            document.getElementById('sundayDate').textContent = formatDate(addDays(startDate, 6));
        }

        function formatDate(date) {
            const day = date.getDate();
            const suffix = getDaySuffix(day);
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            return `${day}${suffix} ${month}`;
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // Admin Functions
        function lockRoster() {
            const config = weekConfigs[currentWeek];
            if (config && config.isHistorical) {
                alert(`Week ${currentWeek} is a historical reference week and is permanently locked.`);
                return;
            }
            isRosterLocked = true;
            updateLockedState();
            alert('Roster locked! All users now have view-only access.');
            downloadJSON(); // Automatically download JSON when locked
        }

        function unlockRoster() {
            const config = weekConfigs[currentWeek];
            if (config && config.isHistorical) {
                alert(`Week ${currentWeek} is a historical reference week and is permanently locked.`);
                return;
            }
            isRosterLocked = false;
            updateLockedState();
            alert('Roster unlocked! Admin can now make changes.');
        }

        function downloadJSON() {
            const config = weekConfigs[currentWeek];
            // Create the JSON data structure
            const jsonData = {
                scheduleData: {},
                isRosterLocked: isRosterLocked,
                currentWeek: currentWeek,
                currentYear: currentYear,
                dateRange: config.displayDate,
                lastSavedTime: new Date().toISOString(),
                updatedBy: currentUser
            };

            // Convert schedule data to the key-value format
            config.activeUsers.forEach(user => {
                config.scheduleData[user].forEach((shift, dayIndex) => {
                    const dayName = days[dayIndex];
                    jsonData.scheduleData[`${user}-${dayName}`] = shift;
                });
            });

            // Convert to JSON string
            const jsonString = JSON.stringify(jsonData, null, 2);
            
            // Create download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `roster_week${currentWeek}_${currentYear}_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('JSON file downloaded!');
        }

        function login() {
            const userSelect = document.getElementById('userSelect');
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const selectedUser = userSelect.value;
            
            errorMessage.classList.add('hidden');
            
            if (!selectedUser) {
                showError('Please select a user');
                return;
            }
            
            if (!password) {
                showError('Please enter password');
                return;
            }
            
            if (password === userCredentials[selectedUser]) {
                currentUser = selectedUser;
                isAdmin = currentUser === 'Ian';
                localStorage.setItem('currentUser', currentUser);
                showMainApp();
            } else {
                showError('Invalid password');
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('currentUser');
            showLoginPage();
        }

        function renderSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            const config = weekConfigs[currentWeek];
            if (!config) {
                scheduleBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">No schedule data available for this week</td></tr>';
                return;
            }
            
            const activeUsers = config.activeUsers;
            
            activeUsers.forEach(user => {
                const row = document.createElement('tr');
                if (user === currentUser) row.classList.add('current-user');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'user-cell';
                if (user === 'Emma') {
                    nameCell.innerHTML = user + ' <span class="on-leave">(on leave)</span>';
                } else {
                    nameCell.textContent = user;
                }
                row.appendChild(nameCell);
                
                // Shift cells with PROPER COLORS
                config.scheduleData[user].forEach((shift, index) => {
                    const cell = document.createElement('td');
                    
                    // Store user and day index as data attributes
                    cell.setAttribute('data-user', user);
                    cell.setAttribute('data-day', index);
                    
                    // Set initial appearance
                    updateCellAppearance(cell, shift);
                    
                    row.appendChild(cell);
                });
                
                scheduleBody.appendChild(row);
            });

            updateWeekDisplay();
            updateCellEditability();
        }

        // [KEEP ALL YOUR EXISTING ANALYTICS AND MODAL FUNCTIONS - NO CHANGES]
        // ... All analytics functions remain exactly the same ...
        
        // Initialize
        document.addEventListener('DOMContentLoaded', initializePage);

        // [KEEP ALL YOUR EXISTING EVENT LISTENERS - NO CHANGES]
        // ... All event listeners remain exactly the same ...
    </script>
</body>
</html>
